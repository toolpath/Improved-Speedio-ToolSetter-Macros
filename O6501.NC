(TOOL TOUCH OFF SUB PROGRAM)
(PASS IN A T VALUE FOR TOOL TO BE MEASURED)
(NO C VALUE WILL MEASURE TOOL AND WRITE OFFSET)
(C1 WILL INSTEAD WRITE THE CALIBRATION VALUE AFTER TOUCHING OFF THE MASTER TOOL)

#109 = #20 (SAVE TOOL NUMBER BEING MEASURED)
#104 = #3 (SAVE THE PASSED C VALUE)

G65 P6502 (CALL SETTINGS PROGRAM)
G65 P6503 T[#109] (CALL TOOL DATA PROGRAM)

M846 (TURN TOOLSETTER ON)

WHILE[#109LE0]DO1 (IF TOOL NUMBER IS LESS OR EQUAL TO 0, ERROR)
#3000=1 (INVALID T CALL)
END1

WHILE[#109GT#114]DO1 (IF TOOL NUMBER IS GREATER THAN TOOLS AVAILABLE, ERROR)
#3000=1 (INVALID T CALL)
END1

#105=#109-3 (LOADING POSITION IS 3 BEHIND)
WHILE[#105LT1]DO1 (IF LOADING POSITION IS LESS THAN 1)
#105=#105+#114 (ROUND ROBIN BY NUMBER OF POTS IN MAGAZINE)
END1

(JSG NOTE: REMOVED THE PROPOSITION AND BLOCK SKIP)
(T[#105] M6) (POSITION TOOL IN LOADING POSITION)
(/M0)(PROGRAM STOP)

#24=#[#110]+[COS[#117]*[#107/2]] (CALCULATE X POSITION FOR TOUCHOFF)
#25=#[#110+1]+[SIN[#117]*[#107/2]] (CALCULATE Y POSITION FOR TOUCHOFF)

G0 G90
G54.1 P48 (CALL UP A ZERO OFFSET, PROXY MACHINE COORDS)
G100 G49 X[#24] Y[#25] T[#109] (LOAD TOOL TO SPINDLE AND POSITION XY)

IF[#107EQ0]GOTO100 (CENTER TOUCH BECAUSE TOUCH DIAM IS EQUAL TO 0)
IF[#107GT0]GOTO200 (OFFSET TOUCH BECAUSE TOUCH DIAM IS GREATER THAN 0)
#3000=1 (INVALID TOOL SETTINGS)

N100(CENTER TOUCH)
(TURN ON SETTER AIR BLAST HERE WITH YOUR M-CODE)
G91 G131 Z#118 F#111 (SEARCH DOWN IN Z)
G91 G0 Z#113 (BACK OFF AFTER SEARCHING)
#3004=2 (DISABLE FEED OVERRIDE)
G91 G131 Z-[#113*1.5] F#112 (FEED BACK INTO SETTER FOR MEASUREMENT)
#13=#5063 (STORE THE Z SKIP POSITION)
(TURN OFF SETTER AIR BLAST HERE WITH YOUR M-CODE)
#3004=0(ENABLE FEED OVERRIDE AGAIN)
GOTO300

N200(OFFSET TOUCH)
(TURN ON SETTER AIR BLAST HERE WITH YOUR M-CODE)
M19 R#108 (ORIENT TO FIRST INSERT)
G91 G131 Z#118 F#111 (SEARCH DOWN IN Z)
G91 G0 Z#113 (BACK OFF AFTER SEARCHING)
#3004=2 (DISABLE FEED OVERRIDE)
#4=0 (SET COUNTER TO 0)
#13=0 (MEASURE VALUE SET TO 0)
WHILE[#4LT#106]DO1 (WHILE LOOP COUNT IS LT NUMBER OF INSERTS)
#18=#108 + [[#106-#4]*[360/#106]] (CALCULATE ANGLE OF NEXT INSERT)
WHILE[#18GE360.]DO2 (IF GREATER THAN 360, NORMALIZE ANGLE)
#18=#18-360.
END2
M19 R#18 (ORIENT TO NEXT INSERT)
G91 G131 Z-[#113*1.5] F#112 (FEED BACK INTO SETTER FOR MEASUREMENT)
WHILE[#5063GT#13]DO2 (IF THIS INSERTS SKIP COORD IS GREATER THAN PREVIOUS, STORE IT)
#13=#5063
END2
G91 G0 Z#113 (BACK OFF AFTER MEASUREMENT)
#4=#4+1 (INCREMENT COUNTER)
END1 (END OF INSERT TOUCH LOOP)
(TURN OFF SETTER AIR BLAST HERE WITH YOUR M-CODE)
#3004=0(ENABLE FEED OVERRIDE AGAIN)
GOTO300


N300 (TOOL OFFSET WRITING)
IF[#104EQ1]GOTO400 (SKIP TO CALIBRATION STORAGE IF C=1)
#[11000+#109]=#13-#[#110+2] (WRITE TOOL OFFSET, MEAS POSITION MINUS CAL VALUE)
#[10000+#109]=0 (SET WEAR TO 0)
GOTO999 (GO TO END OF PROGRAM)

N400 (CAL VALUE WRITING)
#[#110+2]=#13-#115 (WRITE CAL VALUE AS MEASURE POSITION MINUS MASTER TOOL LENGTH)
GOTO999 (GO TO END OF PROGRAM)

N999
G91 G28 Z0 (RETRACT Z AXIS)
G90
M849 (TURN TOOLSETTER OFF)
M99

